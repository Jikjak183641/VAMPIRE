defmodule PaymentProcessor do
  @moduledoc """
  Payment Processor module for handling various payment operations
  including PayPay integration, user verification, and transaction processing
  """

  @supported_languages [
    "Vietnamese",
    "Korean", 
    "Tagalog",
    "Russian",
    "French",
    "Japanese",
    "Navajo",
    "Chinese"
  ]

  @support_phone "1-888-344-6347"
  @support_tty "711"

  defstruct [
    :user_id,
    :balance,
    :verified,
    :preferred_language,
    :payment_methods,
    :transaction_history
  ]

  @doc """
  Initialize a new user with default values
  """
  def new_user(user_id, preferred_language \\ "English") do
    %__MODULE__{
      user_id: user_id,
      balance: 0.0,
      verified: false,
      preferred_language: preferred_language,
      payment_methods: [],
      transaction_history: []
    }
  end

  @doc """
  Get language support information
  """
  def get_language_support(language) do
    case Enum.member?(@supported_languages, language) do
      true ->
        %{
          message: "Free language support available for #{language}",
          phone: @support_phone,
          tty: @support_tty
        }
      false ->
        %{
          message: "Language support not available for #{language}",
          phone: @support_phone,
          tty: @support_tty
        }
    end
  end

  @doc """
  Verify user identity for payment services
  """
  def verify_identity(user, identity_documents) do
    case validate_documents(identity_documents) do
      {:ok, _} ->
        updated_user = %{user | verified: true}
        {:ok, updated_user}
      {:error, reason} ->
        {:error, "Identity verification failed: #{reason}"}
    end
  end

  @doc """
  Process payment using PayPay balance
  """
  def process_payment(user, amount, merchant_info) do
    cond do
      not user.verified ->
        {:error, "User not verified. Please complete identity verification first."}
      
      user.balance < amount ->
        {:error, "Insufficient balance. Current balance: #{user.balance}"}
      
      amount <= 0 ->
        {:error, "Invalid payment amount: #{amount}"}
      
      true ->
        new_balance = user.balance - amount
        transaction = %{
          id: generate_transaction_id(),
          amount: amount,
          merchant: merchant_info,
          timestamp: DateTime.utc_now(),
          status: :completed
        }
        
        updated_user = %{
          user | 
          balance: new_balance,
          transaction_history: [transaction | user.transaction_history]
        }
        
        {:ok, updated_user, transaction}
    end
  end

  @doc """
  Recharge PayPay balance from bank account
  """
  def recharge_balance(user, amount, bank_details) do
    case validate_bank_details(bank_details) do
      {:ok, _} ->
        new_balance = user.balance + amount
        transaction = %{
          id: generate_transaction_id(),
          amount: amount,
          type: :recharge,
          timestamp: DateTime.utc_now(),
          status: :completed
        }
        
        updated_user = %{
          user | 
          balance: new_balance,
          transaction_history: [transaction | user.transaction_history]
        }
        
        {:ok, updated_user}
      
      {:error, reason} ->
        {:error, "Bank details validation failed: #{reason}"}
    end
  end

  @doc """
  Generate QR code for merchant payment
  """
  def generate_qr_code(user, amount) do
    %{
      user_id: user.user_id,
      amount: amount,
      timestamp: DateTime.utc_now(),
      qr_data: Base.encode64("PAYPAY:#{user.user_id}:#{amount}:#{:os.system_time()}")
    }
  end

  @doc """
  Get transaction history with filtering options
  """
  def get_transaction_history(user, filters \\ %{}) do
    transactions = user.transaction_history
    
    transactions
    |> Enum.filter(fn transaction ->
      filter_transaction(transaction, filters)
    end)
    |> Enum.sort_by(& &1.timestamp, {:desc, DateTime})
  end

  defp validate_documents(documents) do
    # Simplified document validation
    required_fields = [:name, :id_number, :expiry_date]
    
    case Enum.all?(required_fields, &Map.has_key?(documents, &1)) do
      true -> {:ok, :documents_valid}
      false -> {:error, "Missing required document fields"}
    end
  end

  defp validate_bank_details(bank_details) do
    required_fields = [:account_number, :bank_name, :routing_number]
    
    case Enum.all?(required_fields, &Map.has_key?(bank_details, &1)) do
      true -> {:ok, :bank_details_valid}
      false -> {:error, "Missing required bank details"}
    end
  end

  defp generate_transaction_id do
    :crypto.strong_rand_bytes(16)
    |> Base.encode16()
    |> String.downcase()
  end

  defp filter_transaction(transaction, filters) do
    Enum.all?(filters, fn {key, value} ->
      case key do
        :min_amount -> transaction.amount >= value
        :max_amount -> transaction.amount <= value
        :type -> transaction.type == value
        :status -> transaction.status == value
        :date_from -> DateTime.compare(transaction.timestamp, value) != :lt
        :date_to -> DateTime.compare(transaction.timestamp, value) != :gt
        _ -> true
      end
    end)
  end
end